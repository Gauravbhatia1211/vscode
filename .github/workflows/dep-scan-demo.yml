name: 'Automated Dependency Confusion Scan'

on:
  workflow_dispatch: # Allows manual triggering from the Actions tab
  push:
    branches: [ main ] # Runs automatically on every push to main

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Check out the repository's code
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      # Step 2: Run your custom-built scanner module
      # This assumes:
      #   1. Your scanner module is located at '.github/actions/dep-scanner-v2'
      #   2. Your config file is located at '.github/dependency-scanner.json'
      - name: 'Run Automated Dependency Confusion Scanner'
        id: dep_scan
        uses: ./.github/actions/dep-scanner-v2 # Path to your action
        with:
          config-file: '.github/dependency-scanner.json' # Path to your config file
          report-name: 'dependency_report.json'

      # Step 3: Upload the final report as an artifact
      # This will always run, even if the 'dep_scan' step fails (e.g., if it finds a vulnerability)
      - name: 'Upload Scan Report'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-confusion-report
          path: ${{ steps.dep_scan.outputs.report_path }}
